use anyhow::Result;
use log::debug;
use test_engine::{
    from_main,
    refs::Weak,
    ui::{
        view, Anchor, Color, HasText, Label, NumberView, TextAlignment, ViewData, ViewSetup, ViewSubviews, UI,
    },
    ui_test::{helpers::check_colors, inject_touches},
    App,
};

#[view]
struct LabelTestView {
    #[init]
    label:          Label,
    text_size_view: NumberView<f32>,
}

impl ViewSetup for LabelTestView {
    fn setup(mut self: Weak<Self>) {
        self.label.set_text("ßšėčыў");
        self.label.place().back().size(280, 280).center();

        self.text_size_view
            .place()
            .size(50, 100)
            .center_y()
            .anchor(Anchor::Right, self.label, 10);
        self.text_size_view.set_value(32.0).set_step(5.0);

        self.text_size_view.on_change(move |size| {
            self.label.set_text_size(size);
        });
    }
}

pub async fn test_label() -> Result<()> {
    let mut view = UI::init_test_view::<LabelTestView>().await;

    App::set_window_size((400, 400)).await;

    check_colors(
        r"
              36  109 -  25  51  76
             149  173 - 255 255 255
             191  171 - 255 255 255
             229  173 - 255 255 255
             265  176 - 255 255 255
             311  175 - 255 255 255
             267  198 - 255 255 255
             227  196 - 255 255 255
             179  196 - 155 155 155
             147  195 - 255 255 255
             127  216 - 255 255 255
             158  215 - 255 255 255
             197  215 - 255 255 255
             245  213 - 102 102 102
             286  215 - 255 255 255
             150  196 -   1   1   1
             209  199 - 255 255 255
             237  197 - 255 255 255
             263  203 - 255 255 255
             214  279 - 255 255 255
             201  119 - 255 255 255
             192   42 -  25  51  76
             180  371 -  25  51  76
    ",
    )
    .await?;

    inject_touches(
        r"
            1   200  b
            31   200  e
            30   200  b
            30   200  e
            30   201  b
            30   201  e
            30   201  b
            30   201  e
            29   201  b
            29   201  e
            29   201  b
            29   201  e
            29   201  b
            29   201  e
            30   201  b
            30   201  e
            30   201  b
            30   201  e
            30   201  b
            30   201  e

    ",
    )
    .await;

    from_main(move || {
        view.label.set_text_color(Color::BLUE);
    })
    .await;

    check_colors(
        r"
              87  150 - 255 255 255
              85  181 - 255 255 255
              84  200 - 255 255 255
              93  214 - 180 180 239
              94  239 - 255 255 255
             123  234 - 255 255 255
             129  208 - 255 255 255
             131  183 -   0   0 203
             135  161 - 255 255 255
             158  149 - 255 255 255
             180  156 - 255 255 255
             178  192 - 255 255 255
             175  212 - 255 255 255
             176  237 - 255 255 255
             217  234 - 255 255 255
             230  228 - 255 255 255
             229  215 -   1   1 203
             227  202 - 255 255 255
             220  174 - 255 255 255
             219  141 - 255 255 255
             236  137 - 255 255 255
             264  159 - 255 255 255
             262  184 - 255 255 255
             261  215 - 255 255 255
             261  228 - 255 255 255
             292  225 - 255 255 255
             289  206 -   1   1 203
             298  149 - 255 255 255
             320  146 - 255 255 255
             326  169 -   0   0 203
             318  199 - 255 255 255
             316  216 -   1   1 203
             316  234 -  23  23 207
             336  232 - 255 255 255
             318  229 -   1   1 203
             305  229 - 255 255 255
             303  210 - 255 255 255
             285  205 -  36  36 211
             238  202 - 255 255 255
             204  199 -   0   0 203
             160  196 -   1   1 203
             112  199 - 255 255 255
              82  206 - 255 255 255
    ",
    )
    .await?;

    from_main(move || {
        view.label.set_text_size(28);
        view.add_view::<Label>()
            .set_text("Left Left")
            .set_alignment(TextAlignment::Left)
            .place()
            .lrt(60)
            .h(60);
        view.add_view::<Label>()
            .set_text("Right")
            .set_alignment(TextAlignment::Right)
            .place()
            .lrb(60)
            .h(60);
    })
    .await;

    check_colors(
        r"
              27  321 -  25  51  76
              34  321 -  25  51  76
              41  321 -  25  51  76
              57  322 -  25  51  76
              64  323 - 255 255 255
              83  321 - 255 255 255
              92  321 - 255 255 255
             119  320 - 255 255 255
             127  320 - 255 255 255
             162  319 - 255 255 255
             222  308 - 255 255 255
             223  308 - 255 255 255
             254  302 -   0   0   0
             262  298 - 162 162 162
             284  295 - 255 255 255
             290  296 - 255 255 255
             321  307 - 255 255 255
             328  307 - 255 255 255
             338  309 - 255 255 255
             359  312 -  25  51  76
             350  336 -  25  51  76
             322  352 -  25  51  76
             301  364 -  25  51  76
             279  346 -  25  51  76
             254  327 - 255 255 255
             252  305 -  27  27  27
             275  290 - 255 255 255
             291  285 - 255 255 255
             318  300 -   0   0   0
             330  322 - 255 255 255
             317  348 -  25  51  76
             292  344 -  25  51  76
             257  338 - 255 255 255
             254  291 - 255 255 255
             286  286 - 255 255 255
             312  308 -   1   1   1
             377   76 -  25  51  76
             299   74 - 255 255 255
             297   75 - 255 255 255
             230   72 - 255 255 255
             191   68 - 255 255 255
             176   72 - 255 255 255
             164   81 - 155 155 155
              99   77 - 255 255 255
              99   77 - 255 255 255
              89   87 - 255 255 255
              55   87 -  25  51  76
              53   87 -  25  51  76
              63   61 - 255 255 255
              96   53 -  25  51  76
             118   47 -  25  51  76
             136   79 - 255 255 255
             128  106 - 255 255 255
             164  104 - 255 255 255
             158   68 - 255 255 255
             139   56 -  25  51  76
             103   65 - 255 255 255
             111   88 - 255 255 255
              92   96 -   0   0   0
              77   83 - 255 255 255
              62   83 - 255 255 255
              62   83 - 255 255 255
              50   86 -  25  51  76
              83   86 - 255 255 255
              94   86 - 255 255 255
             153   85 - 255 255 255
             160   85 -   1   1   1
             189   86 - 255 255 255
        ",
    )
    .await?;

    debug!("Label test: OK");

    Ok(())
}
